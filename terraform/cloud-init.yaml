#cloud-config

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - nginx
  - certbot
  - python3-certbot-nginx
  - git
  - curl

runcmd:
  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker
  
  # Add ubuntu user to docker group
  - usermod -aG docker ubuntu
  
  # Create application directory
  - mkdir -p /opt/a-icon
  - chown ubuntu:ubuntu /opt/a-icon
  
  # Create data directory for persistence
  - mkdir -p /opt/a-icon/data
  - chown -R ubuntu:ubuntu /opt/a-icon/data
  
  # Configure Nginx
  - rm -f /etc/nginx/sites-enabled/default
  
  # Create Nginx config for a-icon.com
  - |
    cat > /etc/nginx/sites-available/a-icon.com <<'EOF'
    server {
        listen 80;
        server_name ${domain} www.${domain};
        
        client_max_body_size 10M;
        
        location / {
            proxy_pass http://localhost:4200;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api {
            proxy_pass http://localhost:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
    EOF
  
  - ln -s /etc/nginx/sites-available/a-icon.com /etc/nginx/sites-enabled/
  - nginx -t
  - systemctl restart nginx
  
  # Note: SSL will be configured after deployment via deploy script

write_files:
  - path: /opt/a-icon/README.md
    content: |
      # A-Icon Deployment
      
      This directory contains the deployed a-icon.com application.
      
      ## Deployment
      
      The application is deployed via the deploy.sh script which:
      1. Pulls the latest code from the repository
      2. Builds Docker images
      3. Starts the containers with docker-compose
      
      ## SSL Certificate
      
      SSL certificates are managed by Let's Encrypt and auto-renewed via certbot.
      
      ## Logs
      
      View logs with:
      - docker-compose logs -f api
      - docker-compose logs -f web

